---
title: 博客评论系统搭建
tags: 博客构建
date: 2026-02-06
top_img: transparent
comments: false
---

## 一、 核心架构 (Architecture)

这套方案采用了 **计算与存储分离** 的 Serverless 架构，完全免费且高可用。

- **前端 (Frontend)**: Hexo 博客 (Butterfly 主题) —— 负责展示界面。
- **后端 (Backend)**: Vercel (运行 Twikoo 云函数) —— 负责处理逻辑（增删改查）。
- **数据库 (Database)**: MongoDB Atlas —— 负责持久化存储数据。
- **网关 (Gateway)**: Cloudflare + 自定义子域名 —— 负责国内加速与流量转发。

---

## 二、 详细部署流程

### 1. 数据库层：MongoDB Atlas (存数据)

- **注册与创建**: 注册账号 -> 创建 Cluster (集群) -> 选择 **M0 Sandbox** (免费版) -> 地区选 Singapore (推荐)。
- **创建用户 (Database Access)**:
  - 添加新用户 -> 设置 Username/Password。
  - **关键点**: 必须记住密码，不能包含特殊字符（建议纯数字字母）。
  - 权限选 `Read and write to any database`。
- **开放网络 (Network Access)**:
  - 添加 IP -> `0.0.0.0/0` (允许全网访问，以便 Vercel 连接)。
- **获取连接串 (Connection String)**:
  - 点击 Connect -> Drivers。
  - 复制 URI: `mongodb+srv://admin:<password>@cluster...`
  - **关键操作**: 将 `<password>` 替换为实际密码，去掉尖括号。

### 2. 后端层：Vercel (跑代码)

- **获取代码**:
  - 去 Twikoo GitHub 仓库 -> 点击 **Fork** (复制到自己账号)。
- **导入项目**:
  - Vercel 控制台 -> Add New Project -> Import 刚才 Fork 的仓库。
- **配置根目录 (Root Directory) 🔥核心坑点**:
  - 必须点击 Edit -> 选择 `src/server/vercel` (或者叫 `vercel-app`) 目录。
  - _原因：Twikoo 是多平台项目，Vercel 的代码在子目录里。_
- **配置环境变量 (Environment Variables)**:
  - Key: `MONGODB_URI`
  - Value: 刚才修改好的 MongoDB 连接串。
- **部署**: 点击 Deploy -> 等待撒花 (Congratulations)。

### 3. 网络层：域名绑定 (通网络)

- **Vercel 端**:
  - Settings -> Domains -> 添加子域名 `comments.magic486.top`。
  - 获取 CNAME 目标值 (通常是 `cname.vercel-dns.com`)。
- **Cloudflare 端**:
  - DNS -> Add Record -> 类型 **CNAME**。
  - Name: `comments`。
  - Target: `cname.vercel-dns.com`。
  - Proxy Status: **开启小黄云** (利用 CF 优选节点加速)。
- **验证**: 等待 Vercel 后台域名显示两个绿勾 ✅。

### 4. 前端层：Hexo 配置 (接显示)

- **修改文件**: `_config.butterfly.yml`。
- **启用 Twikoo**:
  YAML
  ```
  comments:
    use: Twikoo
    # ...其他保持默认
  ```
- **配置地址**:
  YAML
  ```
  twikoo:
    envId: https://comments.magic486.top  # 必须带 https://
    # ...其他保持默认
  ```
- **发布**: `git push` 触发 GitHub Actions 自动构建。

---

## 三、 维护与管理 (Ops)

1. **管理评论**:
   - 无需后台地址。直接在博客文章的评论区，点击右下角“齿轮”图标。
   - 首次使用需设置 **管理密码**。
   - 功能：删除骚扰评论、置顶、通过审核等。

2. **更新版本**:
   - 因为代码是 Fork 的，当 Twikoo 有新功能时，去 GitHub 点击 "Sync Fork" -> Vercel 会自动检测更新并重新部署。

3. **数据备份**:
   - 数据都在 MongoDB 云端，即使误删了 Vercel 项目，重新部署并填入相同的 `MONGODB_URI`，评论数据依然在。

---

## 💡 遇到的坑与解决方案 (Troubleshooting)

1. **Vercel 一键部署报错**:
   - _现象_: "An unexpected error occurred"。
   - _解决_: 改用 **Fork + 手动导入** 模式，稳如老狗。

2. **Vercel 部署失败 (404/500)**:
   - _原因_: 没设置 Root Directory。
   - _解决_: 必须指定到 `src/server/vercel` 目录。

3. **连不上数据库**:
   - _原因_: 连接串里的 `<password>` 没替换，或者包含特殊字符被转义了。
   - _解决_: 检查连接串，确保密码是纯文本且正确。
