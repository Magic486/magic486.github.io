---
title: 力扣刷题日报机器人
tags: 爬虫
top_img: transparent
comments: false
---

**项目原理**：利用 GitHub 免费服务器，每天定时抓取好友的力扣总做题数，与昨天的数据对比计算“今日新增”，并把排名战报发到企业微信群。

---

## 第一步：准备企业微信机器人

1. 在电脑上打开你要推送消息的**企业微信群**。
2. 点击右上角 `...` -> `添加群机器人` -> `新创建一个机器人`。
3. 起个名字（比如：`刷题监督员`），点击添加。
4. **【重要】** 复制生成的 **Webhook 地址**（格式是 `https://qyapi.weixin.qq.com/...`），保存好，后面要用。

---

## 第二步：准备代码文件

在电脑桌面上新建一个文件夹，里面新建两个文本文件，分别命名为 `main.py` 和 `requirements.txt`。

### 文件 1：`main.py` (完整代码)

_请将下面的代码完整复制进去。唯一需要修改的是 `FRIEND_LIST` 里的用户 ID。_

```Python
import requests
import json
import os
import pandas as pd
import datetime
# 好友列表：请填入力扣主页 URL 中的 ID
# 例如: https://leetcode.cn/u/bu-huo-m/ -> ID 是 bu-huo-m
FRIEND_LIST = [
    "XXX"
]

# 历史数据存储文件
HISTORY_FILE = "history.json"
# 从 GitHub 环境变量获取 Webhook
WEBHOOK_URL = os.environ.get("WECOM_WEBHOOK")

def get_total_solved(user_slug):
    """获取用户刷题总数 (无需 Cookie)"""
    url = "https://leetcode.cn/graphql/"
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36',
        'Content-Type': 'application/json'
    }
    query = """
    query userQuestionProgress($userSlug: String!) {
      userProfileUserQuestionProgress(userSlug: $userSlug) {
        numAcceptedQuestions {
          count
        }
      }
    }
    """
    try:
        resp = requests.post(url, headers=headers, json={
            "operationName": "userQuestionProgress",
            "variables": {"userSlug": user_slug},
            "query": query
        }, timeout=10)
        data = resp.json()
        if 'data' in data and data['data']['userProfileUserQuestionProgress']:
            questions = data['data']['userProfileUserQuestionProgress']['numAcceptedQuestions']
            return sum(q['count'] for q in questions)
        return None
    except Exception as e:
        print(f"Error fetching {user_slug}: {e}")
        return None

def load_history():
    if os.path.exists(HISTORY_FILE):
        try:
            with open(HISTORY_FILE, 'r') as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_history(data):
    with open(HISTORY_FILE, 'w') as f:
        json.dump(data, f, indent=4)

def send_wechat_msg(markdown_text):
    if not WEBHOOK_URL:
        print("❌ 未配置 Webhook，跳过发送")
        return
    headers = {'Content-Type': 'application/json'}
    data = {
        "msgtype": "markdown",
        "markdown": {"content": markdown_text}
    }
    requests.post(WEBHOOK_URL, json=data, headers=headers)

def main():
    history = load_history()
    new_history = {}
    report_data = []

    print("🚀 开始获取数据...")
    for user in FRIEND_LIST:
        current_total = get_total_solved(user)
        if current_total is not None:
            last_total = history.get(user, current_total)
            delta = current_total - last_total
            report_data.append({
                "User": user,
                "Total": current_total,
                "Delta": delta
            })
            new_history[user] = current_total
            print(f" - {user}: {current_total} (新增 {delta})")
        else:
            new_history[user] = history.get(user, 0)
            print(f" - {user}: 获取失败")

    save_history(new_history)

    if report_data:
        df = pd.DataFrame(report_data)
        df = df.sort_values(by=["Delta", "Total"], ascending=False)

        # 获取北京时间
        bj_time = datetime.datetime.utcnow() + datetime.timedelta(hours=8)
        now_str = bj_time.strftime('%m-%d %H:%M')

        md_text = f"# 🏆 算法小分队战报\n"
        md_text += f"📅 统计时间：{now_str}\n"
        md_text += f"> 今日全员累计新增：**{sum(df['Delta'])}** 题\n\n"

        rank = 1
        for _, row in df.iterrows():
            if row['Delta'] > 0:
                delta_str = f"<font color=\"warning\">+{row['Delta']}</font>"
                icon = "🔥"
            else:
                delta_str = "+0"
                icon = "😴"
            md_text += f"**No.{rank} {row['User']}** {icon}\n"
            md_text += f"└ 总刷题：`{row['Total']}`  今日：{delta_str}\n\n"
            rank += 1

        md_text += "--------\n💪 *每天进步一点点，坚持就是胜利！*"
        send_wechat_msg(md_text)

if __name__ == "__main__":
    main()
```

### 文件 2：`requirements.txt`

_里面只需要写这几个字母，用于告诉服务器安装必要的库。_

```Plaintext
requests
pandas
```

---

## 第三步：上传 GitHub 并配置密钥

1. **创建仓库**：登录 GitHub，点击右上角 `+` -> `New repository`，起个名字（例如 `leetcode-daily`），选择 **Private**（私有）或 Public 都可以，点击创建。
2. **上传代码**：点击 `uploading an existing file`，把刚才的 `main.py` 和 `requirements.txt` 拖进去，点击 `Commit changes`。
3. **配置机器人链接**：
   - 点击仓库上方的 `Settings` (设置)。
   - 左侧栏点击 `Secrets and variables` -> `Actions`。
   - 点击 `New repository secret` (绿色按钮)。
   - **Name** 填：`WECOM_WEBHOOK` (必须一模一样，全大写)。
   - **Secret** 填：第一步里复制的那个企业微信机器人链接。
   - 点击 `Add secret`。

---

## 第四步：设置自动运行

注：github action的脚本自动运行会有大概二十分钟的延迟

1. 点击仓库上方的 `Actions` 标签。
2. 点击 `set up a workflow yourself`。
3. 把原来的代码全删掉，复制粘贴下面的配置：

```YAML
name: Daily Algorithm Rank

on:
  schedule:
    # 每天北京时间 23:00 运行 (GitHub是UTC时间，15:00 UTC = 23:00 北京)
    - cron: '0 15 * * *'
  workflow_dispatch: # 允许手动点按钮测试

jobs:
  run-monitor:
    runs-on: ubuntu-latest

    # 【重要】赋予写权限，用于保存历史数据
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Run script
      env:
        # 读取刚才配置的机器人密钥
        WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
      run: python main.py

    - name: Commit and Push History
      run: |
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "action@github.com"
        git add history.json || true
        if git diff --staged --quiet; then
          echo "No changes to history"
        else
          git commit -m "Update daily stats [skip ci]"
          git push
        fi
```

4. 点击右上角 `Commit changes` 保存。

---

## 第五步：开启写权限

为了让机器人能保存每天的数据（不然每次运行完数据就丢了），必须做这一步：

1. 点击仓库上方的 `Settings`。
2. 左侧点击 `Actions` -> `General`。
3. 拉到最下面找到 **Workflow permissions**。
4. 选中 **Read and write permissions** (读写权限)。
5. 点击 `Save`。

---

## 完成后如何验证？

1. 点击 `Actions` 标签。
2. 点击左侧的 `Daily Algorithm Rank`。
3. 点击右侧的 `Run workflow` 按钮 -> 绿色 `Run workflow`。
4. 等待约 30 秒，你的企业微信群就会收到第一条战报！
